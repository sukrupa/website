namespace :deploy do
    wgetresult = "1"
    task :staging do 
        set :bootstrap_servertype, "-d"
        set :target_server, "twu-staging" 
        server "#{server}"
        set :user, "go"
        set :deploy_to, "/var/opt/sukrupa/sukrupa-website"
        default
        create_apache_config_file
        create_apache_symlink
        restart_apache    
    end

    task :beta do
        set :bootstrap_servertype, "-b"
        set :target_server, "beta.sukrupa.org"
        server "#{target_server}", :abcd
        set :user, "sukrupaweb"
        set :deploy_to, "/home/sukrupaweb/beta.sukrupa.org"
        default
        move_in_wp_config
    end

    task :beta_env_no_upload do
        set :bootstrap_servertype, "-b"
        set :target_server, "beta.sukrupa.org"
        server "#{target_server}", :abcd
        set :user, "sukrupaweb"
        set :deploy_to, "/home/sukrupaweb/beta.sukrupa.org"
        run_bootstrap
        move_in_wp_config
    end

    task :default do
        setup_wordpress
        safety_check
    end

    task :setup_wordpress do
        upload_artifact
        run_bootstrap
    end
    task :upload_artifact do
        run "mkdir -p #{deploy_to}/content #{deploy_to}/database-backups"
        %w(./content ./bootstrap.sh ./conf ./lib ./scripts ./sukrupa-theme).each do |folder| 
          upload folder, "#{deploy_to}/", :via => :scp, :recursive => true
        end
    end
    task :run_bootstrap do
        run "cd #{deploy_to} && sh bootstrap.sh #{bootstrap_servertype}" 
        run "rm #{deploy_to}/bootstrap.sh" 
        # TODO, you need to later edit permissions to block these files
        run "rm -r #{deploy_to}/lib" 
    end
    
    task :move_in_wp_config do
      run "cp #{deploy_to}/../conf/wp-config-beta.php #{deploy_to}/installed-wordpress/wp-config.php"
    end

    task :create_apache_symlink do
        run "#{sudo} ln -sf #{deploy_to}/conf/apache-sukrupa-dev.conf /etc/apache2/sites-enabled/apache-sukrupa.conf"
    end
    task :create_apache_config_file do
        run "cd #{deploy_to} && cp conf/apache-sukrupa-dev.conf.sample conf/apache-sukrupa-dev.conf"
        run "cd #{deploy_to} && sed -i 's:##sukrupa-website-path##:#{deploy_to}:g' conf/apache-sukrupa-dev.conf"
        run "cd #{deploy_to} && sed -i 's:##server-name##:#{deploy_to}:g' conf/apache-sukrupa-dev.conf"
    end
    task :restart_apache do
        run "#{sudo} /etc/init.d/apache2 restart"
    end

    task :safety_check do
        (1..3).each do
            wgetresult = system "wget --spider http://#{target_server}"
            break if wgetresult
            sleep 2        
        end
        fail "Could not contact webserver: #{target_server}" unless wgetresult
    end
end
